###############################################################################
# Knight Tree - Add a Student to an Existing Tree or Create a New Tree Effect #
###############################################################################

knight_tree_se = {
	$ACTOR$ = { save_temporary_scope_as = teacher }
	$RECIPIENT$ = { save_temporary_scope_as = student }
	if = {
		limit = { scope:student = { is_alive = yes } scope:teacher = { is_alive = yes } }
		scope:teacher = {
			if = { # If the teacher already has a tree
				limit = {
					has_variable = my_knight_tree
				}
				scope:student = { # Create tree for student and assign teacher
					set_variable = {
						name = my_knight_tree
						value = scope:teacher.var:my_knight_tree
					}
				}
				if = { # If the teacher already has students
					limit = {
						any_owned_story = {
							story_type = story_cycle_teacher
						}
					}
					random_owned_story = { # Add this student to the existing list of students
						limit = { story_type = story_cycle_teacher }
						add_to_variable_list = {
							name = students
							target = scope:student
						}
					}
				}
				else = { # If the teacher does not have students yet
					create_story = {
						type = story_cycle_teacher
						save_temporary_scope_as = teacher_story
					}
					if = {
						limit = { # Removes errors
							exists = scope:teacher_story
						}
						scope:teacher_story = { # Create list of students and add this student to it
							add_to_variable_list = {
								name = students
								target = scope:student
							}
						}
						var:my_knight_tree = { # Future trash bag
							add_to_variable_list = {
								name = prune
								target = scope:teacher_story
							}
						}
					}
				}
			}
			else = { # If the teacher does not already have a tree
				create_story = {
					type = story_cycle_teacher
					save_temporary_scope_as = teacher_story
				}
				create_story = {
					type = story_cycle_teacher_tree
					save_temporary_scope_as = teacher_story_tree
				}
				if = {
					limit = { # Removes errors
						exists = scope:teacher_story
						exists = scope:teacher_story_tree
					}
					scope:teacher_story = { # Create list of students and add this student to it
						add_to_variable_list = {
							name = students
							target = scope:student
						}
					}
					scope:teacher_story_tree = { # Assign founder position
						set_variable = {
							name = my_knight_tree_founder
							value = scope:teacher
						}
						add_to_variable_list = { # Future trash bag
							name = prune
							target = scope:teacher_story
						}
						add_to_variable_list = { # Temporary GUI
							name = my_knight_tree_gui
							target = scope:teacher
						}
						if = {
							limit = { # Removes errors
								always = no
								has_variable_list = my_knight_tree_gui
							}
						}
					}
					set_variable = { # Create tree for teacher and tag story ID
						name = my_knight_tree
						value = scope:teacher_story_tree
					}
					scope:student = { # Create tree for student and tag story ID
						set_variable = {
							name = my_knight_tree
							value = scope:teacher_story_tree
						}
					}
					add_to_global_variable_list = { # Add the story ID to the global list for use in scripted GUIs and GUI values
						name = global_teacher_trees
						target = scope:teacher_story_tree
					}
				}
			}
		}
	}
}
